---
title: "Prepare Data for Bundling with MAVIS App"
output: html_document
date: "2023-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_constants}

source("create_constants.R")

```

## NVC Floristic tables

Prepare the NVC floristic tables.

```{r load_raw_NVCForTab, include=FALSE}

nvc_floristic_tables_raw <- read.csv(file = "../data/raw_data/NVC-floristic-tables.csv")

```

```{r create_NVCForTab, include=FALSE}

nvc_floristic_tables_tidied <- nvc_floristic_tables_raw |>
  dplyr::filter(is.na(Special.variable.value)) |>
  dplyr::select("NVC.Code" = Community.or.sub.community.code, 
                "Species" = Species.name.or.special.variable,
                "Constancy" = Species.constancy.value) |>
  dplyr::mutate("Species" = stringr::str_trim(Species))

```

```{r save_NVCForTab, include=FALSE}

saveRDS(object = nvc_floristic_tables_tidied, file = "../data/bundled_data/nvc_floristic_tables.rds")

```

Retrieve the NVC community codes.

```{r create_NVCCodes, include=FALSE}

nvc_name_to_code <- read.csv(file = "../data/raw_data/NVC-floristic-tables.csv") |>
  dplyr::select("Community.or.sub.community.name", "Community.or.sub.community.code") |>
  dplyr::distinct()

nvc_community_codes <- nvc_name_to_code |>
  dplyr::pull("Community.or.sub.community.code")

```

```{r save_NVCCodes, include=FALSE}

saveRDS(object = nvc_community_codes, file = "../data/bundled_data/nvc_community_codes.rds")

```

## Prepare bundled examples

```{r prepare_exampleData, include=FALSE}

dominCoverMidPointPerc_df <- tibble::enframe(dominCoverMidPointPerc) |>
  dplyr::rename("domin" = name,
                "Cover" = value)

example_data_df_all <- readRDS(file = "../data/raw_data/assignNVC_test_dataset.rds") |>
  dplyr::arrange(ID) |>
  dplyr::select("Sample" = ID, "Species" = species, "Site" = site, domin) |>
  dplyr::mutate("domin" = as.character(domin)) |>
  dplyr::left_join(dominCoverMidPointPerc_df, by = "domin") |>
  dplyr::select(-domin) |>
  dplyr::filter(Site != "")

exampleDataOptions <- example_data_df_all$Site |> unique()

setNames(exampleDataOptions, exampleDataOptions)

exampleDataOptions <- c("None" = "none", exampleDataOptions)

example_data_df_samples_per_site <- example_data_df_all |>
  dplyr::group_by(Site) |>
  dplyr::summarise(samples_per_site = dplyr::n())

example_data_df_trimmed <- example_data_df_all |>
  # Create a site sample number
  dplyr::group_by(Site) |>
  dplyr::mutate("Site.Sample" = as.integer(factor(Sample))) |>
  dplyr::ungroup() |>
  # Select only 5 samples per site as example data
  dplyr::filter(Site.Sample <= 5) |>
  dplyr::select(-Site.Sample)

```

Save the example data option names and example data.

```{r save_exampleData, include=FALSE}

saveRDS(object = exampleDataOptions, file = "../data/bundled_data/exampleDataOptions.rds")

saveRDS(object = example_data_df_trimmed, file = "../data/bundled_data/example_data_df.rds")

```

## BSBI taxon concepts

```{r bsbiTaxonCon_raw_data, include=FALSE}

bsbiTaxonConcepts <- readr::read_delim("../data/raw_data/bsbi_checklist_BRC_taxonConcepts.csv",
                                       delim = "\t", escape_double = FALSE,
                                       trim_ws = TRUE,
                                       show_col_types = FALSE)

```


## BSBI BRC Codes Checklist

The BSBI BRC Codes checklist provides a concordance between plant taxon names, their BRC code, and the BSBI taxonId.
This concordance allows the use of all other checklist data.

```{r bsbiBRC_raw_data, include=FALSE}

sppName_to_brcCode_raw <- readr::read_delim("../data/raw_data/bsbi_checklist_sppName_to_brcCode.csv", 
                                            delim = "\t", escape_double = FALSE, 
                                            trim_ws = TRUE,
                                            show_col_types = FALSE)

```

Filter the BSBI checklist data so that the preferredTaxon == origTaxon.
This should yield data where there is one unique BRC code per preferred taxon concept.
It does not.

```{r bsbiBRC_preferredTaxon, include=FALSE}

sppName_to_brcCode <- sppName_to_brcCode_raw |>
  dplyr::group_by(dataValue) |>
  # dplyr::filter(preferredTaxon == origTaxon) |>
  dplyr::filter(taxonId == origTaxonId) |>
  dplyr::rename("BRC" = "dataValue") |>
  dplyr::mutate("BRC" = as.numeric(BRC)) |>
  dplyr::ungroup()

# If the length is equal there are no duplicate codes
nrow(sppName_to_brcCode) == length(sppName_to_brcCode$BRC |> unique())

```


Find the observations with duplicate BRC codes

```{r bsbiBRC_duplicateCodes, include=FALSE}

sppName_to_brcCode_duplicates <- sppName_to_brcCode |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::ungroup() |>
  dplyr::arrange(BRC)

```

Temporarily rows with non-unique BRC codes are removed.
Instead these need to be fixed.

```{r bsbiBRC_duplicateCodes_fix}

sppName_to_brcCode_NOduplicates <- sppName_to_brcCode |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() == 1) |>
  dplyr::ungroup() |>
  dplyr::arrange(BRC)

sppName_to_brcCode_duplicates_fixed <- sppName_to_brcCode_duplicates |>
  dplyr::filter(taxonId %in% c("2cd4p9h.7mm6vp", # Asplenium adiantum-nigrum L. subsp. adiantum-nigrum
                               "2cd4p9h.bhn", # Dryopteris dilatata (Hoffm.) A.Gray
                               "2cd4p9h.7hgmvc", # Dryopteris borreri (Newman) Newman ex Oberh. & Tavel
                               "2cd4p9h.4ws", # Dryopteris submontana (Fraser-Jenk. & Jermy) Fraser-Jenk.
                               "2cd4p9h.x78", # Thelypteris palustris Schott
                               "2cd4p9h.7mm6g3", # Agrostis canina L. subsp. canina
                               "2cd4p9h.1qza6p", # Arctium nemorosum Lej.
                               "2cd4p9h.yed", # Caltha palustris L. var. palustris
                               "2cd4p9h.7mxsse", # Catabrosa aquatica (L.) P.Beauv. subsp. aquatica
                               "2cd4p9h.ev7", # Cirsium arvense var. setosum
                               "2cd4p9h.krd", # Cotoneaster cambricus J.Fryer & B.Hylmö
                               "2cd4p9h.7mxs93", # Festuca guestfalica Boenn. ex Rchb.
                               "2cd4p9h.c2w", # Galium pumilum Murray
                               "2cd4p9h.56p", # 27 Geum rivale L.
                               "2cd4p9h.2xy74t", # Heracleum sphondylium subsp. flavescens (Willd.) Soó
                               "2cd4p9h.xmq", # Elodea nuttallii (Planch.) H.St.John
                               "2cd4p9h.ype", # Juncus effusus var. spiralis J.McNab
                               "2cd4p9h.8qq", # Juncus tenuis Willd.
                               "2cd4p9h.fgh", # Mentha spicata x suaveolens = M. x villosa Huds.
                               "2cd4p9h.vna", # Mentha spicata L.
                               "2cd4p9h.5dz", # Myosotis discolor Pers.
                               "2cd4p9h.yt4", # Narcissus poeticus x pseudonarcissus = N. x incomparabilis Mill. !!!
                               "2cd4p9h.5gv", # Phyteuma orbiculare L.
                               "2cd4p9h.cf0", # Populus deltoides x nigra = P. x canadensis Moench
                               "2cd4p9h.pap", # Viola tricolor L. subsp. tricolor
                               "2cd4p9h.pc2", # Salix alba x babylonica = S. x sepulcralis Simonk.
                               "2cd4p9h.q7y", # Atriplex longipes x prostrata = A. x gustafssoniana Tascher.
                               "2cd4p9h.60c", # Atriplex x gustafssoniana var. kattegatensis (Turesson) Tascher
                               "2cd4p9h.7mm4pq", # Rosa vosagiaca (N.H.F.Desp.) Déségl.
                               "2cd4p9h.pec", # Lepidium virginicum L.
                               "2cd4p9h.63f", # Rosa arvensis x canina = R. x irregularis Déségl. & Guillon
                               "2cd4p9h.wby", # Rosa arvensis x micrantha = R. x vituperabilis Duffort ex Rouy
                               "2cd4p9h.d0k", # Rosa canina x tomentosa = R. x scabriuscula Sm.
                               "2cd4p9h.mev", # Rosa vosagiaca x tomentosa (f x m)
                               "2cd4p9h.g5r", # Rosa tomentella x rubiginosa = R. x timbalii Crép. (f x m)
                               "2cd4p9h.2ee", # Heracleum sphondylium x mantegazzianum
                               "2cd4p9h.mez", # Epilobium parviflorum x ciliatum = E. x floridulum Smejkal
                               "2cd4p9h.wer", # Dactylorhiza lapponica (Laest. ex Hartm.) Soó
                               "2cd4p9h.9me", # Cedrus atlantica f. glaucissima
                               "2cd4p9h.1qzc35", # Potentilla anglica x reptans = P. x mixta Nolte ex Rchb. s.s.
                               "2cd4p9h.7mm2kn", # Hieracium tricolorans (Zahn) Pugsley
                               "2cd4p9h.2vp", # Hieracium diaphanum Fr.
                               "2cd4p9h.wgm", # Hieracium orcadense W.R.Linton
                               "2cd4p9h.7mm0eb", # Bromus brevis Nees ex Steud.
                               "2cd4p9h.mk6", # Hieracium sommerfeltii Lindeb.
                               "2cd4p9h.gch", # Hieracium acuminatum Jord.
                               "2cd4p9h.7mxscc", # Hieracium deganwyense Pugsley
                               "2cd4p9h.7mxsxp", # 	Rubus affinis Weihe & Nees, nom. illegit.
                               "2cd4p9h.ppd", # Crocus neapolitanus x tommasinianus
                               "2cd4p9h.d92", # Galanthus woronowii Losinsk.
                               "2cd4p9h.mmw", # Rosa arvensis x rugosa = R. x paulii Rehder
                               "2cd4p9h.ggm", # Rubus erythrops Edees & A.Newton
                               "2cd4p9h.myt", # Rubus x loganobaccus L.H.Bailey
                               "2cd4p9h.6vy", # Taraxacum faeroense (Dahlst.) Dahlst.
                               "2cd4p9h.bh8", # Taraxacum maculosum A.J.Richards
                               "2cd4p9h.a7m", # Fascicularia bicolor (Ruiz & Pav.) Mez
                               "2cd4p9h.7mr67e", # Taraxacum stenoglossum Brenner
                               "2cd4p9h.71m", # Epipactis leptochila (Godfery) Godfery s.s. 
                               "2cd4p9h.84w5fq", # Carex flava x demissa = C. x alsatica Zahn
                               "2cd4p9h.7mm4yd", # Rosa x subcollina (Christ) Vuk.
                               "2cd4p9h.3hx4n7" # Silene vulgaris subsp. angustifolia (Mill.) Hayek
                               )
                )


sppName_to_brcCode_fixedDuplicates <- rbind(sppName_to_brcCode_NOduplicates, sppName_to_brcCode_duplicates_fixed)

length(sppName_to_brcCode_fixedDuplicates$BRC) == nrow(sppName_to_brcCode_fixedDuplicates)


```

The BSBI BRC codes differ from the assignNVC and regular BRC codes by having a
leading 0 and a number of extra 0's after the two-number identifer.
Fix.

```{r bsbiBRC_fixBRCCodes}
# Align the BSBI BRC codes with assignNVC BRC codes
sppName_to_brcCode_alignedCodes <- sppName_to_brcCode_fixedDuplicates |>
  dplyr::mutate("BRC" = stringr::str_remove(string = BRC, pattern = "^0")) |>
  dplyr::mutate("BRC" = stringr::str_remove(string = BRC, pattern = "(?<=\\d)0+(?=0)")) |>
  dplyr::select(key, BRC, taxonId, preferredQualifiedTaxonName, preferredTaxon, preferredTaxonQualifier, origTaxon) |>
  # Shouldn't be any duplicates, there aren't.
  dplyr::distinct()

```

There are duplicate BRC codes due to families not adhering to the fix rule

```{r bsbiBRC_duplicateCodes_postFix}
sppName_to_brcCode_alignedCodes_duplicates <- sppName_to_brcCode_alignedCodes |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::ungroup() |>
  dplyr::arrange(BRC)

sppName_to_brcCode_alignedCodes_duplicatesFamilies <- sppName_to_brcCode_alignedCodes_duplicates |>
  dplyr::filter(stringr::str_detect(preferredTaxon, pattern = "^[A-Za-z]+$"))

```

Remove families from the data.
This needs to be checked.

```{r bsbiBRC_duplicateCodes_fix2}

sppName_to_brcCode_alignedCodes <- sppName_to_brcCode_alignedCodes |>
  dplyr::filter(!stringr::str_detect(preferredTaxon, pattern = "^[A-Za-z]+$")) |>
  dplyr::filter(!is.na(BRC)) |>
  dplyr::mutate("BRC" = as.numeric(BRC))

length(sppName_to_brcCode_alignedCodes$BRC) == nrow(sppName_to_brcCode_alignedCodes)

```


```{r bsbiBRC_checkNoAbsentCodes}

sppName_to_brcCode_alignedCodes_NOBRC <- sppName_to_brcCode_alignedCodes |>
  dplyr::filter(is.na(BRC)) |>
  dplyr::select(key) |>
  dplyr::distinct()

nrow(sppName_to_brcCode_alignedCodes_NOBRC) == 0

```


```{r bsbiBRC_save_data, include=FALSE}

saveRDS(object = sppName_to_brcCode_alignedCodes, file = "../data/bundled_data/sppName_to_brcCode.rds")

```

## Pseudo-quadrat data

```{r ps_raw_data, include=FALSE}

nvc_pquads_raw <- assignNVC::nvc_pquads

```

```{r ps_speciesBRC_uniq, include=FALSE}

nvc_pquads_speciesBRC <- nvc_pquads_raw |>
  dplyr::select(species, BRC) |>
  dplyr::distinct()

```

There are a total of 22 plant species in `assignNVC::nvc_pquads` without BRC codes.

```{r ps_speciesBRC_noCodes, include=FALSE}

nvc_pquads_speciesBRC_noCodes <- nvc_pquads_speciesBRC |>
  dplyr::filter(is.na(BRC))

nvc_pquads_speciesBRC_noCodes

```

Manually add codes to missing species.

```{r ps_fixNoCodes, include=FALSE}

# Retrieved BRC codes from PLANATT
nvc_pquads_raw_fixMissPlantCodes <- nvc_pquads_raw |>
  dplyr::mutate(
    "BRC" = 
      dplyr::case_when(
        species == "Stellaria media agg." ~ 09202012,
        species == "Cochlearia officinalis" ~ 0920535,
        species == "Matricaria maritima" ~ 09201241.3,
        species == "Atriplex prostrata" ~ 0920214,
        species == "Polygonum aviculare" ~ 09201523,
        species == "Spergula arvensis" ~ 09201987,
        species == "Amaranthus retroflexus" ~ 092092,
        species == "Aster tripolium (rayed)" ~ 0920204,
        species == "Algal mat" ~ 22,
        species == "Triglochin maritima" ~ 09202101,
        species == "Juncus gerardi" ~ 09201069,
        species == "Amblystegium riparium" ~ 0820366,
        species == "Aster tripolium (unrayed)" ~ 0920204,
        species == "Zostera marina" ~ 09202239,
        species == "Zostera angustifolia" ~ 09202238,
        species == "Zostera noltii" ~ 09202240,
        species == "[Alga]" ~ 22,
        species == "Bromus racemosus" ~ 0920271,
        species == "Bromus commutatus" ~ 0920262,
        species == "Oenanthe silaifolia" ~ 09201368,
        species == "Polygala oxyptera" ~ 09201515,
        species == "Festuca pratensis x Lolium perenne (x Festulolium loli" ~ 0920815,
        TRUE ~ as.numeric(BRC)
      )
  )

```

Update nvc_pquads_speciesBRC

```{r ps_speciesBRC_uniq, include=FALSE}

nvc_pquads_speciesBRC <- nvc_pquads_raw_fixMissPlantCodes |>
  dplyr::select(species, BRC) |>
  dplyr::distinct()

nrow(nvc_pquads_speciesBRC |> dplyr::filter(is.na(BRC))) == 0

```

There are 112 observations in `assignNVC::nvc_pquads` which appear more than once.

```{r ps_duplicates, include=FALSE}

nvc_pquads_raw_dupes <- nvc_pquads_raw_fixMissPlantCodes  |>
  dplyr::group_by(species, BRC, Pid2, NVC, Pid3, counter) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::distinct() |>
  dplyr::ungroup()

nvc_pquads_raw_dupes

```

Remove the duplicate observations.

```{r ps_NOduplicates, include=FALSE}

nvc_pquads_fixed <- nvc_pquads_raw_fixMissPlantCodes |>
  dplyr::group_by(species, BRC, Pid2, NVC, Pid3, counter) |>
  # Remove duplicates
  dplyr::filter(dplyr::n() == 1) |>
  # Add duplicates
  rbind(nvc_pquads_raw_dupes)|>
  dplyr::ungroup() |>
  as.data.frame()

```

Filter for unique species-BRC code combinations.
Note the the starting-number taxon group associations:
  - 2: Algae
  - 5: Lichens
  - 7: Charophytes
  - 8: Bryophytes
  - 9: Plants
  
```{r split_nvcpquads_intoTaxaGroups}

nvc_pquads_speciesBRC_algae <- nvc_pquads_speciesBRC |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[2]")) 

nvc_pquads_speciesBRC_lichens <- nvc_pquads_speciesBRC |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[5]")) 

nvc_pquads_speciesBRC_charophytes <- nvc_pquads_speciesBRC |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[7]")) 

nvc_pquads_speciesBRC_bryophytes <- nvc_pquads_speciesBRC |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[8]")) 

nvc_pquads_speciesBRC_plants <- nvc_pquads_speciesBRC |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[9]")) 

nrow(nvc_pquads_speciesBRC) == nrow(rbind(nvc_pquads_speciesBRC_algae,
                                          nvc_pquads_speciesBRC_lichens,
                                          nvc_pquads_speciesBRC_charophytes,
                                          nvc_pquads_speciesBRC_bryophytes,
                                          nvc_pquads_speciesBRC_plants))



```

```{r save_ps, include=FALSE}

# saveRDS(object = nvc_pquads_fixed, file = "../data/bundled_data/nvc_pquads_tidied.rds")

```


## Align Pseudo-quadrat data with BSBI BRC Codes

```{r join_ps_BSBIBRC, include=FALSE}

length(nvc_pquads_speciesBRC_plants$BRC) == nrow(nvc_pquads_speciesBRC_plants)

# nvc_pquads_speciesBRC_plants is 1190 rows
# sppName_to_brcCode_alignedCodes is 9060 rows
# nvc_pquads_joinedBSBIBRC is 1190 rows, success!!!

nvc_pquads_joinedBSBIBRC <- nvc_pquads_speciesBRC_plants |>
  dplyr::mutate("BRC" = as.numeric(BRC)) |>
  dplyr::left_join(sppName_to_brcCode_alignedCodes, 
                   by = "BRC") |>
  dplyr::distinct()

```

Check which species have no associated BSBI data, there are a total of 90 species missing.
We can do nothing about this for now.

```{r ps_BSBIBRC_noData_spp}

nvc_pquads_joinedBSBIBRC_none <- nvc_pquads_joinedBSBIBRC |>
  dplyr::filter(is.na(key))

```

This is to be expected as the pseudo-quadrat data contains other non-plant taxonomic groups.
Check how many missing species there are by taxonomic group.

## Use BSBI taxon concept data to match taxonIds

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc <- nvc_pquads_joinedBSBIBRC_none |>
  dplyr::select(species, BRC) |>
  dplyr::rename("origTaxon" = "species") |>
  dplyr::left_join(bsbiTaxonConcepts, by = "origTaxon")

```

Species in `assignNVC::nvc_pquads` without a BRC code matching in BSBI BRC checklist
but with taxon name matching in BSBI taxon concept checklist

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_present <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc |>
  dplyr::filter(!is.na(key))

```

70 of the 90 missing species have a matching species name & associated BSBI taxonId.

Check there are no non-unique BRC codes

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_present_dupes <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_present |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::distinct() |>
  dplyr::ungroup()

nrow(nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_present_dupes) == 0

```

Species in `assignNVC::nvc_pquads` without a BRC code matching in BSBI BRC checklist
and without taxon name matching in BSBI taxon concept checklist

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_absent <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc  |>
  dplyr::filter(is.na(key))

```

Make some more manual fixes and join again.

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix <- nvc_pquads_joinedBSBIBRC_none |>
  dplyr::select(species, BRC) |>
  dplyr::filter(stringr::str_detect(string = BRC, pattern = "^[9]")) |>
  dplyr::rename("origTaxon" = "species") |>
  dplyr::mutate(
    origTaxon = dplyr::case_when(
      origTaxon == "Callitriche hamulata sens.lat." ~ "Callitriche hamulata",
      origTaxon == "Sagina apetala subsp.erecta" ~ "Sagina apetala subsp. erecta",
      origTaxon == "Salix fragilis (s)" ~ "Salix fragilis",
      origTaxon == "Triglochin maritima" ~ "Triglochin maritimum",
      origTaxon == "Aster tripolium (rayed)" ~ "Aster tripolium",
      origTaxon == "Aster tripolium (unrayed)" ~ "Aster tripolium",
      TRUE ~ as.character(origTaxon)
      
    )
  ) |>
  # dplyr::distinct() |>
  dplyr::left_join(bsbiTaxonConcepts, by = "origTaxon")


```

Re-check species that cannot be matched

```{r}

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_absent <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix  |>
  dplyr::filter(is.na(key))

```


Bind all fixed data...

```{r}

# Original pquads BRC Codes for plants
# 1175 observations
nvc_pquads_speciesBRC_plants

# Unique
nvc_pquads_speciesBRC_plants_distinctBRC <- nvc_pquads_speciesBRC_plants |>
  dplyr::distinct(BRC)

# pquads BRC Codes with corresponding BSBI BRC Codes checklist data - joined cleanly
# 1100 observations
nvc_pquads_joinedBSBIBRC_prepped <- nvc_pquads_joinedBSBIBRC |>
  dplyr::filter(!is.na(key)) |> 
  dplyr::distinct()

length(nvc_pquads_joinedBSBIBRC_prepped$BRC |> unique()) - nrow(nvc_pquads_joinedBSBIBRC_prepped)

nvc_pquads_joinedBSBIBRC_prepped_dupes <- nvc_pquads_joinedBSBIBRC_prepped |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::ungroup()

## No dupes
nvc_pquads_joinedBSBIBRC_prepped_nodupes <- nvc_pquads_joinedBSBIBRC_prepped |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() == 1) |>
  dplyr::ungroup()


# fix dupes
nvc_pquads_joinedBSBIBRC_prepped_fixedDupes <- nvc_pquads_joinedBSBIBRC_prepped_dupes |>
  dplyr::filter(species %in% c("Acer campestre", "Acer pseudoplatanus", "Aira caryophyllea", 
                               "Alnus glutinosa", "Betula pendula", "Betula pubescens", 
                               "Carpinus betulus", "Castanea sativa", "Corylus avellana", 
                               "Crataegus monogyna", "Fagus sylvatica", "Fraxinus excelsior", 
                               "Polypodium vulgare sens.lat.", "Ilex aquifolium", "Juncus gerardii",
                               "Juniperus communis subsp.communis", "Ligustrum vulgare", "Lonicera periclymenum", 
                               "Malus sylvestris", "Tripleurospermum maritimum sens.lat.", "Odontites vernus",
                               "Pinus nigra", "Pinus sylvestris", "Poa trivialis",
                               "Polycarpon tetraphyllum", "Polygala vulgaris", "Polygonum lapathifolium", 
                               "Quercus petraea", "Quercus petraea x robur (g)", "Quercus robur", 
                               "Ranunculus aquatilis", "Ranunculus arvensis", "Rosa canina agg.",
                               "Salix caprea", "Salix cinerea", "Salix pentandra", 
                               "Salix viminalis", "Cytisus scoparius", "Sorbus aucuparia", 
                               "Stellaria media", "Taxus baccata", "Ulex europaeus",
                               "Ulmus minor (c)", "Ulmus glabra (c)", "Viola tricolor", 
                               "Betula pubescens x pendula (c)"))

# join back on
nvc_pquads_joinedBSBIBRC_prepped_correct <- rbind(
  nvc_pquads_joinedBSBIBRC_prepped_nodupes,
  nvc_pquads_joinedBSBIBRC_prepped_fixedDupes
)

# check for dupes again

nvc_pquads_joinedBSBIBRC_prepped_correct_dupes <- nvc_pquads_joinedBSBIBRC_prepped_correct |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::ungroup()
  
# pquads BRC Codes with no corresponding BSBI BRC Codes checklist fixed using BSBI taxon concepts dataset and manual fixes
# 72 observations
nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix |>
  dplyr::filter(!is.na(key)) |> 
  dplyr::distinct() |>
  dplyr::filter(key != "Callitriche hamulata Kütz. ex W.D.J.Koch")

length(nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped$BRC |> unique()) - nrow(nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped)

nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped_dupes <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped |>
  dplyr::group_by(BRC) |>
  dplyr::filter(dplyr::n() > 1) |>
  dplyr::ungroup()



nvc_pquads_joinedBSBIBRC_prepped_correct_ready <- nvc_pquads_joinedBSBIBRC_prepped_correct |>
  dplyr::select(BRC, key, taxonId, preferredQualifiedTaxonName, preferredTaxon, origTaxon)


nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped_ready <- nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped |>
  dplyr::select(BRC, key, taxonId, preferredQualifiedTaxonName, preferredTaxon, origTaxon)


plants_concordance <- rbind(
  nvc_pquads_joinedBSBIBRC_prepped_correct_ready,
  nvc_pquads_joinedBSBIBRC_none_plants_taxonConc_secondFix_prepped_ready
)

```


## Join best available BRC Code - BSBI taxonId & name concordance data to pquads

Join this back to the original `assignNVC::nvc_pquads` names data and check which species are missing again.

Note that this only includes taxa which are present in nvc_pquads, not all species 
present in both the bsbiChecklistData and bsbiTaxonConcepts.

```{r}

assignNVCCode_to_BSBICode_concordance <- nvc_pquads_speciesBRC_plants |>
  dplyr::left_join(plants_concordance, by = "BRC")

length(assignNVCCode_to_BSBICode_concordance$BRC) == nrow(assignNVCCode_to_BSBICode_concordance)

saveRDS(object = assignNVCCode_to_BSBICode_concordance, file = "../data/bundled_data/assignNVCCode_to_BSBICode_concordance.rds")

```

Final check for missing data, it is the 16 species we expect.

```{r}

nvc_pquads_speciesBRC_plants_joinedConc_missing <- nvc_pquads_speciesBRC_plants_joinedConc |>
  dplyr::filter(is.na(key))


```


## BSBI checklist data

```{r prepare_BSBIChecklistData, include=FALSE}

HE_F <- readr::read_delim("../data/raw_data/bsbi_checklist_HE_F.csv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE,
                          show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "F")

length(HE_F$taxonId) == nrow(HE_F)

HE_L <- readr::read_delim("../data/raw_data/bsbi_checklist_HE_L.csv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE,
                          show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "L")

length(HE_L$taxonId) == nrow(HE_L)

HE_N <- readr::read_delim("../data/raw_data/bsbi_checklist_HE_N.csv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE,
                          show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "N")

length(HE_N$taxonId) == nrow(HE_N)

HE_R <- readr::read_delim("../data/raw_data/bsbi_checklist_HE_R.csv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE,
                          show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "R")

length(HE_R$taxonId) == nrow(HE_R)

HE_S <- readr::read_delim("../data/raw_data/bsbi_checklist_HE_S.csv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE,
                          show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "S")

length(HE_S$taxonId) == nrow(HE_S)

rarityNewAtlas_GB <- readr::read_delim("../data/raw_data/bsbi_checklist_rarityNewAtlas_GB.csv", 
                                       delim = "\t", escape_double = FALSE, 
                                       trim_ws = TRUE,
                                       show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "Rarity - GB")

length(rarityNewAtlas_GB$taxonId) == nrow(rarityNewAtlas_GB)

rarityNewAtlas_Ireland <- readr::read_delim("../data/raw_data/bsbi_checklist_rarityNewAtlas_Ireland.csv", 
                                            delim = "\t", escape_double = FALSE, 
                                            trim_ws = TRUE,
                                            show_col_types = FALSE) |>
  dplyr::select(key, taxonId, dataValue) |>
  dplyr::mutate("dataType" = "Rarity - Ireland")

length(rarityNewAtlas_Ireland$taxonId) == nrow(rarityNewAtlas_Ireland)

bsbiChecklistData <- rbind(
  HE_F,
  HE_L,
  HE_N,
  HE_R,
  HE_S,
  rarityNewAtlas_GB,
  rarityNewAtlas_Ireland
) |>
  tidyr::pivot_wider(names_from = dataType, values_from = dataValue) |>
  dplyr::mutate("F" = as.numeric(`F`),
                "L" = as.numeric(L),
                "N" = as.numeric(N),
                "R" = as.numeric(R),
                "S" = as.numeric(S)) |>
  dplyr::select(-key)

length(bsbiChecklistData$taxonId) == nrow(bsbiChecklistData)

```


```{r save_BSBIChecklistData, include=FALSE}

saveRDS(object = bsbiChecklistData, file = "../data/bundled_data/bsbiChecklistData.rds")

```

```{r}

length(bsbiChecklistData$taxonId) == nrow(bsbiChecklistData)
length(bsbiTaxonConcepts$taxonId) == nrow(bsbiTaxonConcepts)
length(assignNVCCode_to_BSBICode_concordance$taxonId) == nrow(assignNVCCode_to_BSBICode_concordance)

bsbiChecklistData_ready <- bsbiChecklistData

bsbiTaxonConcepts_ready <- bsbiTaxonConcepts |>
  dplyr::select(-c(key, dataValue, origTaxonId, preferredTaxonQualifier, origTaxon, origQualifier, notes, referenceSummary, `reference entity id`))

assignNVCCode_to_BSBICode_concordance_ready <- assignNVCCode_to_BSBICode_concordance |>
  dplyr::select(-c(species, key, preferredQualifiedTaxonName, preferredTaxon, origTaxon))

plants_data <- bsbiTaxonConcepts_ready |>
  dplyr::left_join(bsbiChecklistData_ready, by = "taxonId") |>
  dplyr::left_join(assignNVCCode_to_BSBICode_concordance_ready, by = "taxonId")

length(plants_data$taxonId) == nrow(plants_data)

```



## BRYOATT

```{r bryoatt_raw_data, include=FALSE}

bryoatt_raw <- readxl::read_xls(path = "../data/raw_data/Bryoatt_updated_2017.xls", sheet = "BRYOATT")

```

```{r bryoatt_codesNames, include=FALSE}

bryoatt_codesNames <- bryoatt_raw |>
  dplyr::select("species" = `Taxon name`, 
                "BRC" = BRC_num, 
                "L" = L,	
                "F" = `F`, 
                "R" = R,	
                "N" = N, 
                "S" = S) |>
  dplyr::mutate("BRC" = stringr::str_replace_all(string = BRC, pattern = "\\s*", replacement = "")) |>
  dplyr::mutate("BRC" = as.numeric(BRC))

# No duplicate codes
length(bryoatt_codesNames$BRC) == nrow(bryoatt_codesNames)

```

```{r}

# No duplicate codes
length(nvc_pquads_speciesBRC_bryophytes$BRC) == nrow(nvc_pquads_speciesBRC_bryophytes)

nvc_pquads_speciesBRC_bryophytesBRYOATT <- nvc_pquads_speciesBRC_bryophytes |>
  dplyr::mutate("BRC" = as.numeric(BRC)) |>
  dplyr::rename("pquadName" = "species") |>
  dplyr::left_join(bryoatt_codesNames, by = "BRC")


```

Check for species with no BRYOATT data.

```{r}

nvc_pquads_speciesBRC_bryophytesBRYOATT_noData <-nvc_pquads_speciesBRC_bryophytesBRYOATT |>
  dplyr::filter(is.na(species))

```

12 species are missing. Apply the following code fixes for the full species.

```{r}

nvc_pquads_speciesBRC_bryophytesBRYOATT <- nvc_pquads_speciesBRC_bryophytes |>
  dplyr::mutate("BRC" = as.numeric(BRC)) |>
  dplyr::rename("pquadName" = "species") |>
  dplyr::mutate(
    "BRC" =
      dplyr::case_when(
        pquadName == "Hypnum cupressiforme sens.lat." ~ 8203901.0,
        pquadName == "Racomitrium heterostichum sens.lat." ~ 8201072,
        pquadName == "Microbryum starckeanum s.l." ~ 820500.0,
        pquadName == "Lophocolea bidentata var.bidentata" ~ 8101056,
        pquadName == "Pohlia proligera sensu Smith (1978)" ~ 8201354,
        TRUE ~ as.numeric(BRC)
      )
  ) |>
  dplyr::left_join(bryoatt_codesNames, by = "BRC") |>
  dplyr::select("preferredTaxon" = species, BRC, L, `F`, R, N, S)

```

```{r}

bryophytes_data <- nvc_pquads_speciesBRC_bryophytesBRYOATT

```

## Algae data

```{r}

algae_data <- nvc_pquads_speciesBRC_algae |>
  dplyr::mutate("preferredTaxon" = species)

```

## Lichens data

```{r}

lichens_data <- nvc_pquads_speciesBRC_lichens |>
  dplyr::mutate("preferredTaxon" = species)

```

## Charophytes data

```{r}

charophytes_data <- nvc_pquads_speciesBRC_charophytes |>
  dplyr::mutate("preferredTaxon" = species)

```

## Habitat correspondence data

```{r load_raw_habCorData, include=FALSE}

raw_JNCC_habCor <- readxl::read_xls(path = "../data/raw_data/Habitat-correspondences-2008.xls",
                                    sheet = "master table - sheet protected",
                                    col_types = c("text", "text", "text",
                                                  "text", "text", "text",
                                                  "text", "text", "text",
                                                  "text"))

ukHab_habCor_raw <- readxl::read_xlsx(path = "../data/raw_data/UK Habitat Classification V1-1 including Correspondences_7 Sep 2020_ZMCleaned.xlsx",
                                  sheet = "NVC to UKHab",
                                  skip = 6,
                                  .name_repair = "minimal")

ukHab_namesCodes_raw <- readxl::read_xlsx(path = "../data/raw_data/UK Habitat Classification V1-1 including Correspondences_7 Sep 2020_ZMCleaned.xlsx",
                                          sheet = "Professional Edition Hierarchy",
                                          skip = 0,
                                          .name_repair = "minimal")

```

```{r create_habCorData, include=FALSE}

ukHab_namesCodes_level2 <- ukHab_namesCodes_raw |>
  dplyr::select(`Level 2 code`, `Level 2 Label`) |>
  dplyr::rename("Code" = "Level 2 code", "Label" = "Level 2 Label") |>
  dplyr::filter(!is.na(Code)) |>
  dplyr::mutate("Level" = "2")

ukHab_namesCodes_level3 <- ukHab_namesCodes_raw |>
  dplyr::select(`Level 3 code`, `Level 3 Label`) |>
  dplyr::rename("Code" = "Level 3 code", "Label" = "Level 3 Label") |>
  dplyr::filter(!is.na(Code)) |>
  dplyr::mutate("Level" = "3")

ukHab_namesCodes_level4 <- ukHab_namesCodes_raw |>
  dplyr::select(`Level 4 code`, `Level 4 Label\r\n(Priority Habitats in Bold)`) |>
  dplyr::rename("Code" = "Level 4 code", "Label" = "Level 4 Label\r\n(Priority Habitats in Bold)") |>
  dplyr::filter(!is.na(Code)) |>
  dplyr::mutate("Level" = "4")

ukHab_namesCodes_level5 <- ukHab_namesCodes_raw |>
  dplyr::select(`Level 5 code`, `Level 5 Label\r\n(Including Annex 1 Habitats)`) |>
  dplyr::rename("Code" = "Level 5 code", "Label" = "Level 5 Label\r\n(Including Annex 1 Habitats)") |>
  dplyr::filter(!is.na(Code)) |>
  dplyr::mutate("Level" = "5")

ukHab_namesCodes <- rbind(
  ukHab_namesCodes_level2,
  ukHab_namesCodes_level3,
  ukHab_namesCodes_level4,
  ukHab_namesCodes_level5
)

ukHab_habCor_renamed <- ukHab_habCor_raw

names(ukHab_habCor_renamed) <- c("NVC.Code",
                                 "UKHab.Secondary.Code",
                                 "Level1_Variant1", "Level2_Variant1", "Level3_Variant1", "Level4_Variant1", "Level5_Variant1",
                                 "Level1_Variant2", "Level2_Variant2", "Level3_Variant2", "Level4_Variant2", "Level5_Variant2",
                                 "Level1_Variant3", "Level2_Variant3", "Level3_Variant3", "Level4_Variant3", "Level5_Variant3",
                                 "Level1_Variant4", "Level2_Variant4", "Level3_Variant4", "Level4_Variant4", "Level5_Variant4",
                                 "Level1_Variant5", "Level2_Variant5", "Level3_Variant5", "Level4_Variant5", "Level5_Variant5",
                                 "Level1_Variant6", "Level2_Variant6", "Level3_Variant6", "Level4_Variant6", "Level5_Variant6",
                                 "Level1_Variant7", "Level2_Variant7", "Level3_Variant7", "Level4_Variant7", "Level5_Variant7",
                                 "Level1_Variant8", "Level2_Variant8", "Level3_Variant8", "Level4_Variant8", "Level5_Variant8",
                                 "Level1_Variant9", "Level2_Variant9", "Level3_Variant9", "Level4_Variant9", "Level5_Variant9"
                                 )

ukHab_habCor_final <- ukHab_habCor_renamed |>
  dplyr::select(-UKHab.Secondary.Code) |>
  dplyr::mutate(dplyr::across(dplyr::everything(), as.character)) |>
  tidyr::pivot_longer(cols = !NVC.Code,
                      names_pattern = "(.*)_(.*)",
                      names_to = c("Level", "Variant"),
                      values_to = "Code") |>
  dplyr::distinct() |>
  tidyr::pivot_wider(names_from = Level,
                     values_from = Code) |>
  dplyr::filter(!is.na(Level1)) |>
  dplyr::mutate(
    Level2.Code = stringr::str_c(Level2),
    Level3.Code = stringr::str_c(Level2, Level3),
    Level4.Code = stringr::str_c(Level2, Level3, Level4),
    Level5.Code = stringr::str_c(Level2, Level3, Level4, Level5),
    
  ) |>
  dplyr::select(-c(Variant, Level1, Level2, Level3, Level4, Level5)) |>
  tidyr::pivot_longer(cols = c(Level2.Code, Level3.Code, Level4.Code, Level5.Code),
                      names_to = "Level",
                      values_to = "Code") |>
  dplyr::filter(!is.na(Code)) |>
  dplyr::mutate(
    Level = stringr::str_remove(string = Level,
                                pattern = stringr::fixed(".Code"))
  ) |>
  dplyr::distinct() |>
  dplyr::mutate("Relationship" = "Associated with", .after = "NVC.Code") |>
  dplyr::mutate("Classification" = paste0("UKHab - ", Level), .keep = "unused") |>
  dplyr::left_join(ukHab_namesCodes, by = "Code") |>
  dplyr::select(-Level) |>
  dplyr::select(NVC.Code, Relationship, Code, Label, Classification)


nvc_community_codes <- nvc_name_to_code |>
  dplyr::pull("Community.or.sub.community.code")

saveRDS(object = nvc_community_codes, file = "../data/bundled_data/nvc_community_codes.rds")

tidied_JNCC_habCor_CLASSN1 <- raw_JNCC_habCor |>
  dplyr::filter(CLASSN1 == "National Vegetation Classification") |>
  dplyr::select(-BIOTOPE_SHORT_TERM1,
                -CLASSN1,
                -`...10`) |>
  dplyr::relocate(RELATIONSHIP, .after = BIOTOPE_FULL_TERM1) |>
  dplyr::distinct()
  
tidied_JNCC_habCor_CLASSN1$BIOTOPE_FULL_TERM1 <- gsub("<[^>]+>", "", tidied_JNCC_habCor_CLASSN1$BIOTOPE_FULL_TERM1)
tidied_JNCC_habCor_CLASSN1$BIOTOPE_FULL_TERM2 <- gsub("<[^>]+>", "", tidied_JNCC_habCor_CLASSN1$BIOTOPE_FULL_TERM2)

jncc_habCor_final <- tidied_JNCC_habCor_CLASSN1 |>
  dplyr::select(BIOTOPE_CODE1, RELATIONSHIP, BIOTOPE_CODE2, BIOTOPE_FULL_TERM2, CLASSN2) |>
  dplyr::rename("NVC.Code" = "BIOTOPE_CODE1",
                "Relationship" = "RELATIONSHIP",
                "Code" = "BIOTOPE_CODE2",
                "Label" = "BIOTOPE_FULL_TERM2",
                "Classification" = "CLASSN2")

all_habCor_final <- rbind(
  ukHab_habCor_final,
  jncc_habCor_final
)

```

```{r save_habCorData, include=FALSE}

saveRDS(object = all_habCor_final, file = "../data/bundled_data/all_habCor_final.rds")

```

```{r create_habCorNames, include=FALSE}

all_habCor_classifications <- all_habCor_final |>
  dplyr::pull(Classification) |>
  unique()

```

```{r save_habCorNames, include=FALSE}

saveRDS(object = all_habCor_classifications, file = "../data/bundled_data/all_habCor_classifications.rds")

```


# Create Master Dataset

```{r master_dataset}

master_data <- plants_data |>
  dplyr::bind_rows(bryophytes_data) |>
  dplyr::bind_rows(algae_data) |>
  dplyr::bind_rows(lichens_data) |>
  dplyr::bind_rows(charophytes_data)

length(master_data$taxonId) == nrow(master_data)
length(master_data$preferredTaxon) == nrow(master_data)

saveRDS(object = master_data, file = "../data/bundled_data/master_data.rds")
  

```


# Replace names in nvc_pquads

```{r}

master_data_BRCtoName <- master_data |>
  dplyr::select(preferredTaxon, BRC) |>
  dplyr::filter(!is.na(BRC))

length(master_data_BRCtoName$BRC) == nrow(master_data_BRCtoName)

nvc_pquads_final <- assignNVC::nvc_pquads |>
  dplyr::left_join(master_data_BRCtoName, by = "BRC") |>
  dplyr::distinct() |>
  dplyr::mutate(
    "species" =
      dplyr::case_when(
        is.na(preferredTaxon) ~ species,
        TRUE ~ as.character(preferredTaxon)
      )
  ) |>
  dplyr::select(-preferredTaxon)

saveRDS(object = nvc_pquads_final, file = "../data/bundled_data/nvc_pquads_final.rds")

```



## Species names

Finally, create a list of accepted species names.

```{r create_speciesNames, include=FALSE}

speciesNames <- master_data |>
  # Remove non-species taxa
  # dplyr::filter(!stringr::str_detect(preferredTaxon, pattern = "^[A-Za-z]+$")) |>
  dplyr::pull(preferredTaxon) |>
  unique() |>
  sort()

```


```{r save_speciesNames, include=FALSE}

saveRDS(object = speciesNames, file = "../data/bundled_data/speciesNames.rds")

```
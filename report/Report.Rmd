---
output: 
  pdf_document:
    includes:
      in_header: "Report.preamble.tex"
params: 
    surveyTable: NULL
    surveyTablePrepped: NULL
    nvcAverageSim: NULL
    assignNVCResults: NULL
    floristicTables: NULL
    sidebar_options: NULL
    dcaFixedSpaceResults: NULL
    dcaAllQuadratsResults: NULL
bibliography: Report.refs.bib
link-citations: yes
editor_options: 
  markdown: 
    wrap: 72
title: \textbf{\textcolor{ceh.dark.blue}{MAVIS}}
subtitle: \textbf{\textcolor{ceh.dark.blue}{User Report}}
# author: "Author"
date: \textbf{\textcolor{ceh.dark.blue}{`r Sys.Date()`}}
---

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
```

```{r retrieve_data, message=FALSE, warning=FALSE, include=FALSE}

# source("../create_constants.R", local = knitr::knit_global())
# sys.source("./create_constants.R", envir = knitr::knit_global())

surveyTable <- params$surveyTable
surveyTablePrepped <- params$surveyTablePrepped
nvcAverageSim <- params$nvcAverageSim
assignNVCResults <- params$assignNVCResults
sidebar_options <- params$sidebar_options
floristicTables <- params$floristicTables

# dcaFixedSpaceResults
dcaFixedSpaceResults <- params$dcaFixedSpaceResults
# selected_pquads_dca_results_species_final <- dcaFixedSpaceResults$selected_pquads_dca_results_species
# selected_pquads_dca_results_quadrats_final <- dcaFixedSpaceResults$selected_pquads_dca_results_quadrats_final
surveyTable_dca_results_quadrats <- dcaFixedSpaceResults$surveyTable_dca_results_quadrats
selected_pquads_dca_results_quadrats_final_hull <- dcaFixedSpaceResults$selected_pquads_dca_results_quadrats_final_hull
arrow_plot_data <- dcaFixedSpaceResults$arrow_plot_data

# dcaAllQuadratsResults
dcaAllQuadratsResults <- params$dcaAllQuadratsResults
# pquads_surveyTable_dca_results_species <- dcaAllQuadratsResults$pquads_surveyTable_dca_results_species
pquads_surveyTable_dca_results_quadrats_sample <- dcaAllQuadratsResults$pquads_surveyTable_dca_results_quadrats_sample
# pquads_surveyTable_dca_results_quadrats_pquads <- dcaAllQuadratsResults$pquads_surveyTable_dca_results_quadrats_pquads
pquads_surveyTable_dca_results_quadrats_hull <- dcaAllQuadratsResults$pquads_surveyTable_dca_results_quadrats_hull
arrow_plot_data <- dcaAllQuadratsResults$arrow_plot_data


```

# Introduction
The Modular Analysis of Vegetation Information System (MAVIS) is a tool..

# Input Data Parameters



\newpage
# Results

## Jaccard Similarity - Pseudo-quadrat Method

```{r nvcAverageSimTable, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

nvcAverageSimTable <- nvcAverageSim

kableExtra::kbl(x = nvcAverageSimTable, format = "latex", booktabs = TRUE,
                longtable = TRUE, linesep = "",
                caption = "The top N NVC communities fitted using the pseudo-quadrat method.") |>
  kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))

```

\newpage
## Habitat Correspondences

\newpage
## Composed Floristic Tables

```{r floristicTables, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

for(id in unique(floristicTables$ID)){

  floristicTables_selected <- floristicTables |>
    dplyr::filter(ID == id) |>
    dplyr::select(-ID)

  kableExtra::kbl(x = floristicTables_selected, format = "latex", booktabs = TRUE,
                  longtable = TRUE, linesep = "",
                  caption = paste0("Composed Floristic Table (", as.character(id), ")")) |>
    kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position")) |>
    print()

}

```


\newpage
## Detrended Correspondence Analysis

### Fixed Reference Space

```{r dcaFixedSpace, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

dcaFixedSpacePlot <- ggplot2::ggplot() +
  ggplot2::geom_polygon(data = selected_pquads_dca_results_quadrats_final_hull, alpha = 0.2,
                        mapping = ggplot2::aes(x = DCA1, 
                                               y = DCA2, 
                                               fill = NVC.Comm
                                               )) +
  # ggplot2::geom_point(data = selected_pquads_dca_results_quadrats_final,
  #                     mapping = ggplot2::aes(color = NVC.Comm, 
  #                                            Quadrat = Quadrat, 
  #                                            x = DCA1,
  #                                            y = DCA2)) +
  ggplot2::geom_point(data = surveyTable_dca_results_quadrats,
                      mapping = ggplot2::aes(Year = Year,
                                             Group = Group,
                                             Quadrat = Quadrat,
                                             x = DCA1,
                                             y = DCA2)) +
  ggrepel::geom_text_repel(data = surveyTable_dca_results_quadrats,
                           mapping = ggplot2::aes(label = Quadrat, # paste0(Year, Quadrat, collapse = "-"),
                                                  # Group = Group,
                                                  # Quadrat = Quadrat,
                                                  x = DCA1,
                                                  y = DCA2)) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_species,
  #                     mapping = ggplot2::aes(x = DCA1, 
  #                                            y = DCA2,
  #                                            Species = Species)) +
  # ggplot2::geom_path(data = surveyTable_dca_results_quadrats_final,
  #                    mapping = ggplot2::aes(x = DCA1,
  #                                           y = DCA2),
  #                    arrow = grid::arrow()) +
  ggplot2::theme_minimal()

dcaFixedSpacePlot

```


### All Quadrats

```{r dcaAllQuadrats, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

dcaAllQuadratsPlot <- ggplot2::ggplot() +
  ggplot2::geom_polygon(data = pquads_surveyTable_dca_results_quadrats_hull, alpha = 0.2,
                        mapping = ggplot2::aes(x = DCA1, 
                                               y = DCA2, 
                                               fill = NVC.Comm
                                               )) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_quadrats_pquads,
  #                     mapping = ggplot2::aes(color = NVC.Comm, 
  #                                            Quadrat = Quadrat, 
  #                                            x = DCA1,
  #                                            y = DCA2)) +
  ggplot2::geom_point(data = pquads_surveyTable_dca_results_quadrats_sample,
                      mapping = ggplot2::aes(Year = Year,
                                             Group = Group,
                                             Quadrat = Quadrat,
                                             x = DCA1,
                                             y = DCA2)) +
    ggrepel::geom_text_repel(data = pquads_surveyTable_dca_results_quadrats_sample,
                             mapping = ggplot2::aes(label = Quadrat, # paste0(Year, Quadrat, collapse = "-"),
                                                    # Group = Group,
                                                    # Quadrat = Quadrat,
                                                    x = DCA1,
                                                    y = DCA2)) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_species,
  #                     mapping = ggplot2::aes(x = DCA1, 
  #                                            y = DCA2,
  #                                            Species = Species)) +
  # ggplot2::geom_path(data = surveyTable_dca_results_quadrats_final,
  #                    mapping = ggplot2::aes(x = DCA1,
  #                                           y = DCA2),
  #                    arrow = grid::arrow()) +
  ggplot2::theme_minimal()

dcaAllQuadratsPlot

```



\newpage
# Appendix

## Samples

```{r samplesTable, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

samplesTable <- surveyTablePrepped |>
  dplyr::select(ID) |>
  dplyr::distinct()

kableExtra::kbl(x = samplesTable, format = "latex", booktabs = TRUE,
                longtable = TRUE, linesep = "",
                caption = "Samples assessed in the analysis.") |>
  kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))

```

## Survey Data Table

```{r surveyTable, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

kableExtra::kbl(x = surveyTable, format = "latex", booktabs = TRUE,
                longtable = TRUE, linesep = "",
                caption = "Survey Data Table") |>
  kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))

```


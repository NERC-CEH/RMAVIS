---
output: 
  pdf_document:
    includes:
      in_header: "Report.preamble.tex"
params: 
    sidebar_options: NULL
    surveyTable: NULL
    nvcAssignment: NULL
    floristicTables: NULL
    speciesFreq: NULL
    # avgEIVs: NULL
    # diversityAnalysis: NULL
    # mvaNationalRefResults: NULL
    mvaLocalRefRestrictedResults: NULL
    mvaLocalRefUnrestrictedResults: NULL
    reportAuthorName: NULL
bibliography: Report.refs.bib
link-citations: yes
editor_options: 
  markdown: 
    wrap: 72
title: \textbf{\textcolor{ceh.dark.blue}{pseudoMAVIS}}
subtitle: \textbf{\textcolor{ceh.dark.blue}{Report}}
# date: \textbf{\textcolor{ceh.dark.blue}{`r Sys.Date()`}}
---

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
```

```{r retrieve_data, message=FALSE, warning=FALSE, include=FALSE}

# source("../create_constants.R", local = knitr::knit_global())
# sys.source("./create_constants.R", envir = knitr::knit_global())

surveyTable <- params$surveyTable
nvcAssignment <- params$nvcAssignment
sidebar_options <- params$sidebar_options
floristicTables <- params$floristicTables
speciesFreq <- params$speciesFreq

# Report options
reportOptions <- sidebar_options$reportOptions
reportAuthorName <- params$reportAuthorName
reportProjectName <- sidebar_options$reportProjectName

# mvaLocalRefRestrictedResults
mvaLocalRefRestrictedResults <- params$mvaLocalRefRestrictedResults
# selected_pquads_dca_results_species_final <- mvaLocalRefRestrictedResults$selected_pquads_dca_results_species
# selected_pquads_dca_results_quadrats_final <- mvaLocalRefRestrictedResults$selected_pquads_dca_results_quadrats_final
surveyTable_dca_results_quadrats <- mvaLocalRefRestrictedResults$surveyTable_dca_results_quadrats
selected_pquads_dca_results_quadrats_final_hull <- mvaLocalRefRestrictedResults$selected_pquads_dca_results_quadrats_final_hull
arrow_plot_data <- mvaLocalRefRestrictedResults$arrow_plot_data
CCA_arrowData <- mvaLocalRefRestrictedResults$CCA_arrowData

# mvaLocalRefUnrestrictedResults
mvaLocalRefUnrestrictedResults <- params$mvaLocalRefUnrestrictedResults
# pquads_surveyTable_dca_results_species <- mvaLocalRefUnrestrictedResults$pquads_surveyTable_dca_results_species
pquads_surveyTable_dca_results_quadrats_sample <- mvaLocalRefUnrestrictedResults$pquads_surveyTable_dca_results_quadrats_sample
# pquads_surveyTable_dca_results_quadrats_pquads <- mvaLocalRefUnrestrictedResults$pquads_surveyTable_dca_results_quadrats_pquads
pquads_surveyTable_dca_results_quadrats_hull <- mvaLocalRefUnrestrictedResults$pquads_surveyTable_dca_results_quadrats_hull
arrow_plot_data <- mvaLocalRefUnrestrictedResults$arrow_plot_data


```

\vspace{-15truemm}

```{r reportAuthorName, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

cat("**Name:** ", as.character(reportAuthorName), sep = "")

```

```{r reportProjectName, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

cat("**Project:** ", as.character(reportProjectName), sep = "")

```

```{r reportProjectDate, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

cat("**Date & Time:** ", as.character(format(Sys.time(), "%Y-%m-%d %H:%M:%S")), sep = "")

```

# Introduction
The Modular Analysis of Vegetation Information System (MAVIS) is a tool..

# Input Data Parameters



\newpage
# Results

## Jaccard Similarity - Pseudo-quadrat Method

```{r nvcAssignmentResultsSite, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("nvcAssignmentResultsSite" %in% reportOptions){
  
  nvcAssignmentResultsSite <- nvcAssignment

  kableExtra::kbl(x = nvcAssignmentResultsSite, format = "latex", booktabs = TRUE,
                  longtable = TRUE, linesep = "",
                  caption = "The top N NVC communities fitted using the pseudo-quadrat method.") |>
    kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))
  
}

```


```{r floristicTablesSite, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("composedFloristicTablesSite" %in% reportOptions){
  
  cat("\\newpage")
  cat("## Composed Floristic Tables")
  
  for(id in unique(floristicTables$ID)){

  floristicTables_selected <- floristicTables |>
    dplyr::filter(ID == id) |>
    dplyr::select(-ID)

  kableExtra::kbl(x = floristicTables_selected, format = "latex", booktabs = TRUE,
                  longtable = TRUE, linesep = "",
                  caption = paste0("Composed Floristic Table (", as.character(id), ")")) |>
    kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position")) |>
    print()
  }
  
}

```


```{r speciesFrequency, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("speciesFrequencyTable" %in% reportOptions){
  
  cat("\\newpage")
  cat("## Species Frequency")

  speciesFreqTable <- speciesFreq |>
    dplyr::mutate_all(~replace(., is.na(.), ""))
  
  kableExtra::kbl(x = speciesFreqTable, format = "latex", booktabs = TRUE,
                  longtable = TRUE, linesep = "",
                  caption = "The frequency of occurence of each species across all quadrats by year.") |>
    kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))
  
}

```

\newpage

```{r mvaSectionHeader, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# if(){
#   
#   
# }

cat("## Multivariate Analysis")

```




```{r mvaLocalRefRestricted, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("mvaLocalReferenceRestricted" %in% reportOptions){
  
  cat("\\newpage")
  cat("Local Reference, Restricted")
  
  mvaLocalRefRestrictedPlot <- ggplot2::ggplot() +
  ggplot2::geom_polygon(data = selected_pquads_dca_results_quadrats_final_hull, alpha = 0.2,
                        mapping = ggplot2::aes(x = DCA1, 
                                               y = DCA2, 
                                               fill = NVC.Comm
                                               )) +
  # ggplot2::geom_point(data = selected_pquads_dca_results_quadrats_final,
  #                     mapping = ggplot2::aes(color = NVC.Comm, 
  #                                            Quadrat = Quadrat, 
  #                                            x = DCA1,
  #                                            y = DCA2)) +
  ggplot2::geom_point(data = surveyTable_dca_results_quadrats,
                      mapping = ggplot2::aes(Year = Year,
                                             Group = Group,
                                             Quadrat = Quadrat,
                                             x = DCA1,
                                             y = DCA2)) +
  # ggrepel::geom_text_repel(data = surveyTable_dca_results_quadrats,
  #                          mapping = ggplot2::aes(label = Quadrat, # paste0(Year, Quadrat, collapse = "-"),
  #                                                 # Group = Group,
  #                                                 # Quadrat = Quadrat,
  #                                                 x = DCA1,
  #                                                 y = DCA2)) +
  ggplot2::geom_segment(data = CCA_arrowData,
                        color = 'black',
                        arrow = grid::arrow(),
                        mapping = ggplot2::aes(x = 0,
                                               y = 0,
                                               xend = CCA1,
                                               yend = CCA2,
                                               label = `Hill-Ellenberg`)) +
  ggplot2::geom_text(data = CCA_arrowData,
                     color = 'black',
                     # position = ggplot2::position_dodge(width = 0.9),
                     size = 5,
                     mapping = ggplot2::aes(x = CCA1 * 1.075,
                                            y = CCA2 * 1.075,
                                            label = `Hill-Ellenberg`)) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_species,
  #                     mapping = ggplot2::aes(x = DCA1, 
  #                                            y = DCA2,
  #                                            Species = Species)) +
  # ggplot2::geom_path(data = surveyTable_dca_results_quadrats_final,
  #                    mapping = ggplot2::aes(x = DCA1,
  #                                           y = DCA2),
  #                    arrow = grid::arrow()) +
  ggplot2::theme_minimal()

  mvaLocalRefRestrictedPlot
  
}

```


### All Quadrats

```{r mvaLocalRefUnrestricted, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("mvaLocalReferenceUnrestricted" %in% reportOptions){
  
  cat("\\newpage")
  cat("Local Reference, Unrestricted")
  
  mvaLocalRefUnrestrictedPlot <- ggplot2::ggplot() +
  ggplot2::geom_polygon(data = pquads_surveyTable_dca_results_quadrats_hull, alpha = 0.2,
                        mapping = ggplot2::aes(x = DCA1, 
                                               y = DCA2, 
                                               fill = NVC.Comm
                                               )) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_quadrats_pquads,
  #                     mapping = ggplot2::aes(color = NVC.Comm, 
  #                                            Quadrat = Quadrat, 
  #                                            x = DCA1,
  #                                            y = DCA2)) +
  ggplot2::geom_point(data = pquads_surveyTable_dca_results_quadrats_sample,
                      mapping = ggplot2::aes(Year = Year,
                                             Group = Group,
                                             Quadrat = Quadrat,
                                             x = DCA1,
                                             y = DCA2)) +
  # ggrepel::geom_text_repel(data = pquads_surveyTable_dca_results_quadrats_sample,
  #                          mapping = ggplot2::aes(label = Quadrat, # paste0(Year, Quadrat, collapse = "-"),
  #                                                 # Group = Group,
  #                                                 # Quadrat = Quadrat,
  #                                                 x = DCA1,
  #                                                 y = DCA2)) +
  # ggplot2::geom_point(data = pquads_surveyTable_dca_results_species,
  #                     mapping = ggplot2::aes(x = DCA1, 
  #                                            y = DCA2,
  #                                            Species = Species)) +
  # ggplot2::geom_path(data = surveyTable_dca_results_quadrats_final,
  #                    mapping = ggplot2::aes(x = DCA1,
  #                                           y = DCA2),
  #                    arrow = grid::arrow()) +
  ggplot2::theme_minimal()

  mvaLocalRefUnrestrictedPlot
  
}

```



\newpage
# Appendix

```{r samplesTable, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

cat("## Samples")

samplesTable <- surveyTable |>
  dplyr::select(Year, Group, Quadrat) |>
  dplyr::distinct()

kableExtra::kbl(x = samplesTable, format = "latex", booktabs = TRUE,
                longtable = TRUE, linesep = "",
                caption = "Samples assessed in the analysis.") |>
  kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))

```



```{r surveyTable, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

if("surveyTable" %in% reportOptions){
  
  cat("\\newpage")
  cat("## Survey Data Table")

  kableExtra::kbl(x = surveyTable, format = "latex", booktabs = TRUE,
                  longtable = TRUE, linesep = "",
                  caption = "Survey Data Table") |>
    kableExtra::kable_styling(latex_options = c("repeat_header", "HOLD_position"))
  
}

```

